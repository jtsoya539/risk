create table T_FLUJO_INSTANCIA_PASOS
(
  id_paso_instancia     NUMBER generated by default on null as identity(
    minvalue 1
    nomaxvalue
    start with 1
    increment by 1
    nocache
    nocycle
  ),
  id_instancia          NUMBER not null,
  id_paso               NUMBER not null,
  estado                VARCHAR2(20) default 'EN_PROGRESO' not null,
  resultado             VARCHAR2(50),
  fecha_inicio          TIMESTAMP(2) WITH TIME ZONE default CURRENT_TIMESTAMP not null,
  fecha_fin             TIMESTAMP(2) WITH TIME ZONE,
  roles_responsables    VARCHAR2(4000),
  usuarios_responsables VARCHAR2(4000)
)
;
comment on table T_FLUJO_INSTANCIA_PASOS
  is 'Pasos de Instancias de Flujos';
comment on column T_FLUJO_INSTANCIA_PASOS.id_paso_instancia
  is 'Identificador del paso de la instancia';
comment on column T_FLUJO_INSTANCIA_PASOS.id_instancia
  is 'Identificador de la instancia del flujo';
comment on column T_FLUJO_INSTANCIA_PASOS.id_paso
  is 'Identificador del paso del flujo';
comment on column T_FLUJO_INSTANCIA_PASOS.estado
  is 'Estado de la instancia (EN_PROGRESO / FINALIZADO / CANCELADO)';
comment on column T_FLUJO_INSTANCIA_PASOS.resultado
  is 'Resultado del paso de la instancia';
comment on column T_FLUJO_INSTANCIA_PASOS.fecha_inicio
  is 'Fecha de inicio del paso de la instancia';
comment on column T_FLUJO_INSTANCIA_PASOS.fecha_fin
  is 'Fecha de fin del paso de la instancia';
comment on column T_FLUJO_INSTANCIA_PASOS.roles_responsables
  is 'Nombre de roles responsables. En formato JSON Array';
comment on column T_FLUJO_INSTANCIA_PASOS.usuarios_responsables
  is 'Alias de usuarios responsables. En formato JSON Array';
alter table T_FLUJO_INSTANCIA_PASOS
  add constraint PK_FLUJO_INSTANCIA_PASOS primary key (ID_PASO_INSTANCIA);
alter table T_FLUJO_INSTANCIA_PASOS
  add constraint FK_FLUJO_INSTANCIA_PASOS_INSTANCIAS foreign key (ID_INSTANCIA)
  references T_FLUJO_INSTANCIAS (ID_INSTANCIA);
alter table T_FLUJO_INSTANCIA_PASOS
  add constraint FK_FLUJO_INSTANCIA_PASOS_PASOS foreign key (ID_PASO)
  references T_FLUJO_PASOS (ID_PASO);
alter table T_FLUJO_INSTANCIA_PASOS
  add constraint CK_FLJ_INST_PASOS_ESTADO
  check (estado IN ('EN_PROGRESO', 'FINALIZADO', 'CANCELADO'));
alter table T_FLUJO_INSTANCIA_PASOS
  add constraint CK_FLJ_INST_PASOS_ESTADO_FECHA_FIN
  check ((estado IN ('FINALIZADO', 'CANCELADO') AND fecha_fin IS NOT NULL) OR (estado NOT IN ('FINALIZADO', 'CANCELADO') AND fecha_fin IS NULL));
alter table T_FLUJO_INSTANCIA_PASOS
  add constraint CK_FLJ_INST_PASOS_ROL_RESPONSABLES_JSON
  check (roles_responsables IS JSON STRICT WITH UNIQUE KEYS);
alter table T_FLUJO_INSTANCIA_PASOS
  add constraint CK_FLJ_INST_PASOS_USU_RESPONSABLES_JSON
  check (usuarios_responsables IS JSON STRICT WITH UNIQUE KEYS);

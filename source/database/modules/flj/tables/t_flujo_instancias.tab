create table T_FLUJO_INSTANCIAS
(
  id_instancia    NUMBER generated by default on null as identity(
    minvalue 1
    nomaxvalue
    start with 1
    increment by 1
    nocache
    nocycle
  ),
  id_flujo        NUMBER not null,
  estado          VARCHAR2(20) default 'EN_PROGRESO' not null,
  variables       CLOB,
  fecha_inicio    TIMESTAMP(2) WITH TIME ZONE default CURRENT_TIMESTAMP not null,
  fecha_fin       TIMESTAMP(2) WITH TIME ZONE,
  usuario_ingreso VARCHAR2(100)
)
;
comment on table T_FLUJO_INSTANCIAS
  is 'Instancias de un Flujo';
comment on column T_FLUJO_INSTANCIAS.id_instancia
  is 'Identificador de la instancia del flujo';
comment on column T_FLUJO_INSTANCIAS.id_flujo
  is 'Identificador del flujo';
comment on column T_FLUJO_INSTANCIAS.estado
  is 'Estado de la instancia del flujo';
comment on column T_FLUJO_INSTANCIAS.variables
  is 'Variables de la instancia del flujo';
comment on column T_FLUJO_INSTANCIAS.fecha_inicio
  is 'Fecha de inicio de la instancia del flujo';
comment on column T_FLUJO_INSTANCIAS.fecha_fin
  is 'Fecha de fin de la instancia del flujo';
comment on column T_FLUJO_INSTANCIAS.usuario_ingreso
  is 'Usuario que registró la instancia del flujo';
alter table T_FLUJO_INSTANCIAS
  add constraint PK_FLUJO_INSTANCIAS primary key (ID_INSTANCIA);
alter table T_FLUJO_INSTANCIAS
  add constraint FK_FLUJO_INSTANCIAS_FLUJOS foreign key (ID_FLUJO)
  references T_FLUJOS (ID_FLUJO);
alter table T_FLUJO_INSTANCIAS
  add constraint FK_FFLUJO_INSTANCIAS_USUARIO_INGRESO foreign key (USUARIO_INGRESO)
  references T_USUARIOS (ALIAS);
alter table T_FLUJO_INSTANCIAS
  add constraint CK_FLUJO_INSTANCIAS_ESTADO
  check (estado IN ('EN_PROGRESO', 'FINALIZADO', 'CANCELADO'));
alter table T_FLUJO_INSTANCIAS
  add constraint CK_FLUJO_INSTANCIAS_ESTADO_FECHA_FIN
  check ((estado IN ('FINALIZADO', 'CANCELADO') AND fecha_fin IS NOT NULL) OR (estado NOT IN ('FINALIZADO', 'CANCELADO') AND fecha_fin IS NULL));
